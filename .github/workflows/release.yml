name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        include:
          - os: windows-latest
            goos: windows
            goarch: amd64
            binary_suffix: .exe
            asset_name: clipboard-monitor-windows-amd64.exe
          - os: macos-latest
            goos: darwin
            goarch: amd64
            binary_suffix: ""
            asset_name: clipboard-monitor-macos-amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            binary_suffix: ""
            asset_name: clipboard-monitor-macos-arm64
          - os: ubuntu-22.04
            goos: linux
            goarch: amd64
            binary_suffix: ""
            asset_name: clipboard-monitor-linux-amd64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install Linux dependencies
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt-get update

        # Ubuntu 22.04 ä½¿ç”¨ libwebkit2gtk-4.1-dev
        echo "Installing dependencies for Ubuntu 22.04..."
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          libgl1-mesa-dev \
          libxi-dev \
          libxcursor-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxxf86vm-dev

        # éªŒè¯å…³é”®ä¾èµ–
        echo "Verifying dependencies..."
        pkg-config --exists gtk+-3.0 && echo "âœ“ GTK3: OK" || echo "âœ— GTK3: Missing"
        pkg-config --exists webkit2gtk-4.1 && echo "âœ“ WebKit2GTK-4.1: OK" || echo "âœ— WebKit2GTK-4.1: Missing"

        # æ˜¾ç¤º pkg-config è·¯å¾„
        echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "Available .pc files:"
        find /usr/lib/pkgconfig /usr/share/pkgconfig -name "*webkit*" 2>/dev/null || echo "No webkit .pc files found"

    - name: Install macOS dependencies
      if: matrix.os == 'macos-latest'
      run: |
        # macOS dependencies for webview
        echo "Checking macOS dependencies..."
        # ç¡®ä¿ Xcode å‘½ä»¤è¡Œå·¥å…·å·²å®‰è£…
        xcode-select --install 2>/dev/null || echo "Xcode command line tools already installed"
        # æ£€æŸ¥å¿…è¦çš„æ¡†æž¶
        echo "WebKit framework: $(find /System/Library/Frameworks -name "WebKit.framework" 2>/dev/null || echo "Not found")"

    - name: Install Windows dependencies
      if: matrix.os == 'windows-latest'
      run: |
        # Windows dependencies for webview
        echo "Installing Windows dependencies..."
        # ç¡®ä¿æœ‰ C++ æž„å»ºå·¥å…·
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools" -y || echo "Build tools already installed"

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Setup Go proxy and clean cache
      run: |
        go env -w GOPROXY=https://proxy.golang.org,direct
        go env -w GOSUMDB=sum.golang.org
        go clean -modcache

    - name: Download dependencies
      run: |
        go mod tidy
        go mod download

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 1
      shell: bash
      run: |
        echo "Building for ${{ matrix.goos }}/${{ matrix.goarch }}"
        BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

        # æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
        echo "Go version: $(go version)"
        echo "CGO_ENABLED: $CGO_ENABLED"
        echo "GOOS: $GOOS"
        echo "GOARCH: $GOARCH"

        # æ£€æŸ¥ä¾èµ–
        echo "Checking dependencies..."
        go mod verify

        # æž„å»º
        echo "Starting build..."
        if [ "${{ matrix.goos }}" = "windows" ]; then
          echo "Building Windows version with UTF-8 support..."
          go build -v -ldflags="-s -w -H windowsgui -X main.Version=${{ github.ref_name }} -X main.BuildDate=${BUILD_DATE} -X main.GitCommit=${{ github.sha }}" -o ${{ matrix.asset_name }} .
        elif [ "${{ matrix.goos }}" = "linux" ]; then
          echo "Building Linux version..."
          # æ£€æŸ¥ WebKit æ˜¯å¦å¯ç”¨
          if pkg-config --exists webkit2gtk-4.1 || pkg-config --exists webkit2gtk-4.0; then
            echo "WebKit found, proceeding with build..."
            go build -v -ldflags="-s -w -X main.Version=${{ github.ref_name }} -X main.BuildDate=${BUILD_DATE} -X main.GitCommit=${{ github.sha }}" -o ${{ matrix.asset_name }} .
          else
            echo "WebKit not found, build may fail..."
            echo "Attempting build anyway..."
            go build -v -ldflags="-s -w -X main.Version=${{ github.ref_name }} -X main.BuildDate=${BUILD_DATE} -X main.GitCommit=${{ github.sha }}" -o ${{ matrix.asset_name }} . || {
              echo "Build failed due to missing WebKit dependencies"
              echo "This is expected on some Ubuntu versions"
              exit 1
            }
          fi
        else
          echo "Building macOS version..."
          go build -v -ldflags="-s -w -X main.Version=${{ github.ref_name }} -X main.BuildDate=${BUILD_DATE} -X main.GitCommit=${{ github.sha }}" -o ${{ matrix.asset_name }} .
        fi

        echo "Build completed: ${{ matrix.asset_name }}"
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          dir ${{ matrix.asset_name }}
        else
          ls -la ${{ matrix.asset_name }}
        fi

    - name: Create release package
      shell: bash
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release-package

        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp ${{ matrix.asset_name }} release-package/

        # å¤åˆ¶ web æ–‡ä»¶å¤¹
        cp -r web release-package/

        # åˆ›å»º README
        cat > release-package/README.md << 'EOF'
        # å‰ªè´´æ¿ç›‘æŽ§å™¨

        ## ä½¿ç”¨æ–¹æ³•

        1. ç¡®ä¿ `web/` æ–‡ä»¶å¤¹ä¸Žå¯æ‰§è¡Œæ–‡ä»¶åœ¨åŒä¸€ç›®å½•
        2. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶å³å¯å¼€å§‹ä½¿ç”¨

        ## æ–‡ä»¶è¯´æ˜Ž

        - `${{ matrix.asset_name }}`: ä¸»ç¨‹åº
        - `web/`: ç•Œé¢æ–‡ä»¶ï¼ˆå¿…éœ€ï¼‰
        - `README.md`: è¯´æ˜Žæ–‡æ¡£

        ## æ³¨æ„äº‹é¡¹

        è¯·ä¸è¦åˆ é™¤æˆ–ç§»åŠ¨ `web/` æ–‡ä»¶å¤¹ï¼Œç¨‹åºè¿è¡Œéœ€è¦å…¶ä¸­çš„ç•Œé¢æ–‡ä»¶ã€‚
        EOF

        # åˆ›å»ºåŽ‹ç¼©åŒ…
        if [ "${{ matrix.goos }}" = "windows" ]; then
          # Windows ä½¿ç”¨ zip
          cd release-package
          7z a -tzip ../clipboard-monitor-${{ matrix.goos }}-${{ matrix.goarch }}.zip .
          cd ..
        else
          # Unix ç³»ç»Ÿä½¿ç”¨ tar.gz
          tar -czf clipboard-monitor-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz -C release-package .
        fi

        # æ˜¾ç¤ºæ‰“åŒ…ç»“æžœ
        ls -la clipboard-monitor-${{ matrix.goos }}-${{ matrix.goarch }}.*

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: clipboard-monitor-${{ matrix.goos }}-${{ matrix.goarch }}
        path: |
          clipboard-monitor-${{ matrix.goos }}-${{ matrix.goarch }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## å‰ªè´´æ¿ç›‘å¬å™¨ ${{ github.ref_name }}

          ### ä¸‹è½½

          é€‰æ‹©é€‚åˆä½ æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š

          - **Windows**: clipboard-monitor-windows-amd64.zip
          - **macOS (Intel)**: clipboard-monitor-darwin-amd64.tar.gz
          - **macOS (Apple Silicon)**: clipboard-monitor-darwin-arm64.tar.gz
          - **Linux**: clipboard-monitor-linux-amd64.tar.gz

          ### åŠŸèƒ½ç‰¹æ€§

          - ðŸ” å®žæ—¶ç›‘å¬å‰ªè´´æ¿å˜åŒ–
          - ðŸ“‹ ä¿å­˜åŽ†å²è®°å½•ï¼ˆæœ€è¿‘50æ¡ï¼‰
          - ðŸ–±ï¸ åŒå‡»å¤åˆ¶åŽ†å²å†…å®¹
          - ðŸ—‘ï¸ æ¸…ç©ºåŽ†å²è®°å½•
          - ðŸ”„ æ‰‹åŠ¨åˆ·æ–°åˆ—è¡¨
          - ðŸŒ è·¨å¹³å°æ”¯æŒ
          - ðŸŽ¨ äºŒæ¬¡å…ƒé£Žæ ¼ç•Œé¢
          - âš¡ çŽ°ä»£åŒ– Web UI

          ### ä½¿ç”¨æ–¹æ³•

          1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. ç¡®ä¿ `web/` æ–‡ä»¶å¤¹ä¸Žå¯æ‰§è¡Œæ–‡ä»¶åœ¨åŒä¸€ç›®å½•
          4. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶å³å¯å¼€å§‹ä½¿ç”¨
          5. åŒå‡»åŽ†å²è®°å½•æ¡ç›®å¯å¤åˆ¶å†…å®¹

          ### ç³»ç»Ÿè¦æ±‚

          - Windows 10/11
          - macOS 10.14+
          - Linux (X11 æ¡Œé¢çŽ¯å¢ƒ)

          ### âš ï¸ é‡è¦æç¤º

          - è§£åŽ‹åŽè¯·ä¿æŒ `web/` æ–‡ä»¶å¤¹ä¸Žå¯æ‰§è¡Œæ–‡ä»¶åœ¨åŒä¸€ç›®å½•
          - ä¸è¦å•ç‹¬ç§»åŠ¨å¯æ‰§è¡Œæ–‡ä»¶ï¼Œéœ€è¦æ•´ä¸ªæ–‡ä»¶å¤¹ä¸€èµ·ç§»åŠ¨
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸é˜²ç«å¢™è®¿é—®
        draft: false
        prerelease: false
        files: |
          artifacts/clipboard-monitor-windows-amd64/clipboard-monitor-windows-amd64.zip
          artifacts/clipboard-monitor-darwin-amd64/clipboard-monitor-darwin-amd64.tar.gz
          artifacts/clipboard-monitor-darwin-arm64/clipboard-monitor-darwin-arm64.tar.gz
          artifacts/clipboard-monitor-linux-amd64/clipboard-monitor-linux-amd64.tar.gz


